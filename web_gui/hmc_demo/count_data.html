<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>HMC Demo</title>
        <meta name="description" content="description">
        <meta name="author" content="HMC">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="plugins/bootstrap/bootstrap.css" rel="stylesheet">
        <link href="plugins/jquery-ui/jquery-ui.min.css" rel="stylesheet">
        <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Righteous' rel='stylesheet' type='text/css'>
        <link href="plugins/fancybox/jquery.fancybox.css" rel="stylesheet">
        <link href="plugins/fullcalendar/fullcalendar.css" rel="stylesheet">
        <link href="plugins/xcharts/xcharts.min.css" rel="stylesheet">
        <link href="plugins/select2/select2.css" rel="stylesheet">
        <link href="css/style.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
                <script src="http://getbootstrap.com/docs-assets/js/html5shiv.js"></script>
                <script src="http://getbootstrap.com/docs-assets/js/respond.min.js"></script>
        <![endif]-->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!--<script src="http://code.jquery.com/jquery.js"></script>-->
    <script src="plugins/jquery/jquery-2.1.0.min.js"></script>
    <script src="plugins/jquery-ui/jquery-ui.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="plugins/bootstrap/bootstrap.min.js"></script>
    <script src="plugins/justified-gallery/jquery.justifiedgallery.min.js"></script>
    <script src="plugins/tinymce/tinymce.min.js"></script>
    <script src="plugins/tinymce/jquery.tinymce.min.js"></script>
    <script src="plugins/jquery-csv/jquery.csv.js">/*cannot use .min*/</script>
    <script src="plugins/FileSaver/FileSaver.min.js"></script>
    <script src="plugins/jquery-jeditable/jquery.jeditable.mini.js"></script>
    <script src="plugins/raphael/raphael-min.js"></script>
    <script src="plugins/morris/morris.min.js"></script>
    <!-- All functions for this theme + document.ready processing -->
    <script src="js/devoops.js"></script>
    </head>
<body>
<!--Start Header-->
<div id="screensaver">
    <canvas id="canvas"></canvas>
    <i class="fa fa-lock" id="screen_unlock"></i>
</div>
<div id="modalbox">
    <div class="devoops-modal">
        <div class="devoops-modal-header">
            <div class="modal-header-name">
                <span>Basic table</span>
            </div>
            <div class="box-icons">
                <a class="close-link">
                    <i class="fa fa-times"></i>
                </a>
            </div>
        </div>
        <div class="devoops-modal-inner">
        </div>
        <div class="devoops-modal-bottom">
        </div>
    </div>
</div>
<header class="navbar">
    <div class="container-fluid expanded-panel">
        <div class="row">
            <div id="logo" class="col-xs-12 col-sm-2">
                <a href="index.html"><img src="img/UIC-HealthMediaColab.jpg"></a>
            </div>
            <div id="top-panel" class="col-xs-12 col-sm-10">
                <div class="row">
                    <div class="col-xs-8 col-sm-4">
                        <a href="#" class="show-sidebar">
                          <i class="fa fa-bars"></i>
                        </a>
                        <div id="search">
                            <input type="text" placeholder="search"/>
                            <i class="fa fa-search"></i>
                        </div>
                    </div>
                    <div class="col-xs-4 col-sm-8 top-panel-right">
                        <ul class="nav navbar-nav pull-right panel-menu">
                            <li class="hidden-xs">
                                <a href="index.html" class="modal-link">
                                    <i class="fa fa-bell"></i>
                                    <span class="badge">7</span>
                                </a>
                            </li>
                            <li class="hidden-xs">
                                <a class="ajax-link" href="ajax/calendar.html">
                                    <i class="fa fa-calendar"></i>
                                    <span class="badge">7</span>
                                </a>
                            </li>
                            <li class="hidden-xs">
                                <a href="ajax/page_messages.html" class="ajax-link">
                                    <i class="fa fa-envelope"></i>
                                    <span class="badge">7</span>
                                </a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle account" data-toggle="dropdown">
                                    <div class="avatar">
                                        <img src="img/avatar.jpg" class="img-rounded" alt="avatar" />
                                    </div>
                                    <i class="fa fa-angle-down pull-right"></i>
                                    <div class="user-mini pull-right">
                                        <span class="welcome">Welcome,</span>
                                        <span>Jane Devoops</span>
                                    </div>
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a href="#">
                                            <i class="fa fa-user"></i>
                                            <span>Profile</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ajax/page_messages.html" class="ajax-link">
                                            <i class="fa fa-envelope"></i>
                                            <span>Messages</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ajax/gallery_simple.html" class="ajax-link">
                                            <i class="fa fa-picture-o"></i>
                                            <span>Albums</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ajax/calendar.html" class="ajax-link">
                                            <i class="fa fa-tasks"></i>
                                            <span>Tasks</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#">
                                            <i class="fa fa-cog"></i>
                                            <span>Settings</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#">
                                            <i class="fa fa-power-off"></i>
                                            <span>Logout</span>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
<!--End Header-->
<!--Start Container-->
<div id="main" class="container-fluid">
    <div class="row">
        <div id="sidebar-left" class="col-xs-2 col-sm-2">
            <ul class="nav main-menu">
                <li>
                    <a href="ajax/dashboard.html" class="active ajax-link">
                        <i class="fa fa-dashboard"></i>
                        <span class="hidden-xs">Dashboard</span>
                    </a>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle">
                        <i class="fa fa-bar-chart-o"></i>
                        <span class="hidden-xs">Charts</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="ajax-link" href="ajax/charts_xcharts.html">xCharts</a></li>
                        <li><a class="ajax-link" href="ajax/charts_flot.html">Flot Charts</a></li>
                        <li><a class="ajax-link" href="ajax/charts_google.html">Google Charts</a></li>
                        <li><a class="ajax-link" href="ajax/charts_morris.html">Morris Charts</a></li>
                        <li><a class="ajax-link" href="ajax/charts_coindesk.html">CoinDesk realtime</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle">
                        <i class="fa fa-table"></i>
                         <span class="hidden-xs">Tables</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="ajax-link" href="ajax/tables_simple.html">Simple Tables</a></li>
                        <li><a class="ajax-link" href="ajax/tables_datatables.html">Data Tables</a></li>
                        <li><a class="ajax-link" href="ajax/tables_beauty.html">Beauty Tables</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle">
                        <i class="fa fa-pencil-square-o"></i>
                         <span class="hidden-xs">Forms</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="ajax-link" href="ajax/forms_elements.html">Elements</a></li>
                        <li><a class="ajax-link" href="ajax/forms_layouts.html">Layouts</a></li>
                        <li><a class="ajax-link" href="ajax/forms_file_uploader.html">File Uploader</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle">
                        <i class="fa fa-desktop"></i>
                         <span class="hidden-xs">UI Elements</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="ajax-link" href="ajax/ui_grid.html">Grid</a></li>
                        <li><a class="ajax-link" href="ajax/ui_buttons.html">Buttons</a></li>
                        <li><a class="ajax-link" href="ajax/ui_progressbars.html">Progress Bars</a></li>
                        <li><a class="ajax-link" href="ajax/ui_jquery-ui.html">Jquery UI</a></li>
                        <li><a class="ajax-link" href="ajax/ui_icons.html">Icons</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle">
                        <i class="fa fa-list"></i>
                         <span class="hidden-xs">Pages</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="ajax/page_login.html">Login</a></li>
                        <li><a href="ajax/page_register.html">Register</a></li>
                        <li><a id="locked-screen" class="submenu" href="ajax/page_locked.html">Locked Screen</a></li>
                        <li><a class="ajax-link" href="ajax/page_contacts.html">Contacts</a></li>
                        <li><a class="ajax-link" href="ajax/page_feed.html">Feed</a></li>
                        <li><a class="ajax-link add-full" href="ajax/page_messages.html">Messages</a></li>
                        <li><a class="ajax-link" href="ajax/page_pricing.html">Pricing</a></li>
                        <li><a class="ajax-link" href="ajax/page_invoice.html">Invoice</a></li>
                        <li><a class="ajax-link" href="ajax/page_search.html">Search Results</a></li>
                        <li><a class="ajax-link" href="ajax/page_404.html">Error 404</a></li>
                        <li><a href="ajax/page_500.html">Error 500</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <!--Start Content-->
        <div id="content" class="col-xs-12 col-sm-10">
            <div class="row">
                <div id="breadcrumb" class="col-md-12">
                    <ol class="breadcrumb">
                        <li><a href="#">Dashboard</a></li>
                        <li><a href="#">Tables</a></li>
                        <li><a href="#">Filter Tables</a></li>
                    </ol>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <div class="box-name">
                                <span>Setup Query</span>
                            </div>
                            <div class="box-icons">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                            <div class="no-move"></div>
                        </div>
                        <div class="box-content">
                            <form id="queryform" class="form-horizontal">
                                <div class="form-group">
                                    <div class="col-sm-12">
                                        <div class="checkbox-inline">
                                            <label>
                                                <input type="checkbox" id='querycheck' checked> Use Query:
                                                <i class="fa fa-square-o"></i>
                                            </label>
                                        </div>
                                        <input name='querystring' type="text" id="query" size=100 value="{'mrt' : {'$ne': 7}}"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Date period</label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" id="datestart" placeholder="Date period">
                                    </div>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" id="dateend" placeholder="Date period">
                                    </div>
                                    <div class="col-sm-4">
                                        <label class="control-label">Time Slice</label>
                                        <select id="timeSlice">
                                            <option selected>All</option>
                                            <option>Yearly</option>
                                            <option>Monthly</option>
                                            <option>Weekly</option>
                                            <option>Daily</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-2">
                                        <button type='button' id="submitQuery" class="btn btn-default btn-label-left">
                                            <span><i class="fa fa-rocket txt-danger"></i></span>
                                                Run Query
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <div class="box-name">
                                <span>Query Results</span>
                            </div>
                            <div class="box-icons">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                            <div class="no-move"></div>
                        </div>
                        <div class="box-content">
                            <div id="morris-chart-1" style="height: 400px;"></div>
                            <div id="response">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script type="text/javascript">
            function isJSON (jsonString){
                try {
                    var o = JSON.parse(jsonString);
            
                    // Handle non-exception-throwing cases:
                    // Neither JSON.parse(false) or JSON.parse(1234) throw errors, hence the type-checking,
                    // but... JSON.parse(null) returns 'null', and typeof null === "object", 
                    // so we must check for that, too.
                    if (o && typeof o === "object" && o !== null) {
                        return true;
                    }
                }
                catch (e) { }
            
                return false;
            };

            function MakeSelect2(){
                //$('select').select2();
                $('.dataTables_filter').each(function(){
                    $(this).find('label input[type=text]').attr('placeholder', 'Search');
                });
            }
                
            function setupDatePeriod()
            {
                $('#datestart').datepicker({
                    defaultDate: "+lw",
                    changeMonth: true,
                    changeYear: true,
                    numberOfMonths: 1,
                    maxDate: '0',//set to +0 days from current date
                    minDate: new Date('January 1, 2013 00:00:00'), //set to 1/2013
                    onClose: function( selectedDate ) {
                        $( "#dateend" ).datepicker( "option", "minDate", selectedDate );
                        if($( "#dateend" ).val() == '')
                        {
                            $( "#dateend" ).val(selectedDate);
                        }
                    }
                });
                $('#dateend').datepicker({
                    defaultDate: "+lw",
                    changeMonth: true,
                    changeYear: true,
                    numberOfMonths: 1,
                    maxDate: '0',//set to +0 days from current date
                    minDate: new Date('January 1, 2013 00:00:00'), //set to 1/2013
                    onClose: function( selectedDate ) {
                        $( "#datestart" ).datepicker( "option", "maxDate", selectedDate );
                        if($( "#datestart" ).val() == '')
                        {
                            $( "#datestart" ).val(selectedDate);
                        }
                    }
                });
            };

            $(document).ready(function() {
                // Load Datatables and run plugin on tables 
                //TestTable3(false);//true means Label
                setupDatePeriod();
                
                // Add Drag-n-Drop feature
                WinMove();
                
                $('#submitQuery').on('click', function(e) {
                    var isquery = $('#querycheck').val;
                    var error = false;
                    if(isquery)
                    {
                        var querytext = $('#query').val();
                        var newtext = querytext.replace(/'/g,'"');
                        //Validate querytext if is JSON
                        if(!isJSON(newtext))
                        {
                            OpenModalBox('Form Error', 'Bad query: it is not a JSON');
                            error = true;
                        }
                    } else {
                        var newtext = '';//start with no query
                    }
                    
                    if(error == false)
                    {      
                        var datestart = $('#datestart').val();
                        var dateend = $('#dateend').val();
                        
                        if(datestart == '' || dateend == '')
                        {
                            OpenModalBox('Form Error', 'Bad date start/end: must be filled in');
                        } else {
                            //convert all single ' to "
                            var query = JSON.parse(newtext);
                            var timeslice = $('#timeSlice').val();
                            countData(query,datestart,dateend,timeslice);
                        }
                    }
                });
                
                
                
                //Constants:
                var searchtag = "matchingrulestag";
                var searchrule = "matchingrulesvalue"; //by number
                var dataColumns = ["Idpost","bodypost","retweetCount","generatordname","filterlevel","kloutscore","matchingrulestag1","matchingrulestag2","matchingrulestag3","matchingrulestag4","matchingrulestag5","matchingrulestag6","matchingrulesvalues","matchingrulesvalue1","matchingrulesvalue2","matchingrulesvalue3","matchingrulesvalue4","matchingrulesvalue5","matchingrulesvalue6","languagevalue","favoritesCount","objpostedTime","objsummary","objlink","objid","objobjType","bodyoriginal","actorpreferredusername","actorname","actorlinkshref","actorTimeZone","actorimage","actorverified","actorstatusuesCount","actorsummary","actorlanguages","actorutcOffset","actorlink","actorfollowersCount","actorfavoritesCount","actorfriendsCount","actorlistedCount","actorPostedTime","actorid","actorObjType","entitiesusrmentionsidstr1","entitiesusrmentionssname1","entitiesusrmentionsname1","entitiesusrmentionsidstr2","entitiesusrmentionssname2","entitiesusrmentionsname2","entitiesusrmentionsidstr3","entitiesusrmentionssname3","entitiesusrmentionsname3","entitiesusrmentionsidstr4","entitiesusrmentionssname4","entitiesusrmentionsname4","entitiesusrmentionsidstr5","entitiesusrmentionssname5","entitiesusrmentionsname5","entitieshtagstext1","entitieshtagstext2","entitieshtagstext3","entitieshtagstext4","entitieshtagstext5","entitiesurlexpandedurl","entitiesmdaexpandedurl","lang","postedTime","Year","Month","Day","Time","objgeotype","objlocdname","geotype","geocoordinates","verb","link","locdname","locname","loctwcountrycode","loccountrycode","locgeocoordinates","gniplocdname","gniploccountry","gniplocregion","gniploccounty","gniploclocality","gniplocgeocoordinates","gnipurl","gnipexpandedurl"];
                var timeColumn = "postedTime";
                
                //Start a pull of count data
                function countData(query,datestart,dateend,timeslice) /*sTag,sRule,sTimeStart,sTimeEnd,sSplice*/
                {                  
                    var dddData = {};
                    var chart = null;
                    var isTwitter = true;//temp  
                    var currentCount = 0;
                    var ajaxQuery;
                    //var query = {};
                    var collectionRanges = [];
                    var collectionGroup = 0;
                    var collectionInc = -1;//Will be incremented on first call
                    //query = {'mrt' : {'$ne': 7}};
                    
                    //collectionRange = [datestart, dateend];
                    var increment = 10000;
                    var step = -1;//Will be incremented on first call
                    //var query = {"sTag":sTag,"sRule":sRule,"sTimeStart" :sTimeStart, "sTimeEnd":sTimeEnd, "sSplice":sSplice};
                    var request = {};
                    var scriptLocation = "http://localhost:8000/cgi-bin/test_cgi.py";
                    
                    
                    
                    //Setup query
                    if(!setupQuery(datestart,dateend,timeslice))
                    {
                        OpenModalBox('Form Error', 'Resulted in no query data');
                        return null;
                    }
                    
                    $('#response').html('<h4>Started query</h4> <button type="button" id="endquery" class="btn btn-danger btn-app-sm"><i class="fa fa-spinner fa-spin"></i></button><br><h6 id="updatetime"></h4>');

                    //Create plot after setup done
                    plotData();
                    
                    //Start the cycle
                    nextQuery();
                    
                    
                    
                    $('#endquery').on('click',function ()
                    {
                        ajaxQuery.abort();
                        $('#count').html("CANCELLED");    
                    });
                    
                    //Plots the data
                    function plotData()
                    {
                        //Do not allow a re-plot setup
                        if(chart == null)
                        {  
                            chart = Morris.Bar({
                                element: 'morris-chart-1',
                                data: collectionRanges,
                                xkey: 'slice',
                                ykeys: ['tempresult', 'result'],
                                labels: ['Updating Count', 'Complete Count'],
                                hideHover: true,
                                barColors: ['#A30000','#038C2C'],
                                stacked: true,
                                //xLabelAngle: 60
                            });
                        }
                    };
                    
                    function updatePlot()
                    {
                        chart.setData(collectionRanges);
                    };
                    
                    //Update display of count
                    function updateCount(group,finalUpdate)
                    {
                        if(finalUpdate)
                        {
                            collectionRanges[group]['result'] = currentCount;
                            collectionRanges[group]['tempresult'] = 0;
                            collectionRanges[group]['complete'] = true;
                            updatePlot();
                            //console.log("Finished group");
                        } else {
                            collectionRanges[group]['tempresult'] = currentCount;
                            updatePlot();
                            //console.log("Finished segment");
                        }
                        var newdate = new Date();//gets current time
                        $('#updatetime').html("Last updated: " + newdate.toUTCString());
                    };
                    
                    //Setup all query information
                    function setupQuery(datestart,dateend,timeslice) {
                        
                        var collectionRange = [];
                        var inputStartDate = new Date(datestart);
                        //Set to beginning of day
                        inputStartDate.setHours(0);
                        inputStartDate.setMinutes(0);
                        inputStartDate.setSeconds(0);
                        inputStartDate.setMilliseconds(0);
                        var newStartDate = new Date(inputStartDate.getTime());
                        //Only set to first of month if doing monthly incrementing
                        if(timeslice == 'All' || timeslice == 'Yearly' || timeslice == 'Monthly')
                        {
                            newStartDate.setDate(1);//make the 1st of the month so +1 on month works correctly
                        }
                        var newEndDate = new Date(dateend);
                        //Push to end of day
                        newEndDate.setHours(23);
                        newEndDate.setMinutes(59);
                        newEndDate.setSeconds(59);
                        newEndDate.setMilliseconds(999);
                        var currentWeek = 0;
                        var currentDay = 0;
                        
                        while(dates.compare(newStartDate,newEndDate) <= 0)
                        {
                            var strmonth = (newStartDate.getMonth() + 1).toString();
                            if(strmonth.length < 2) { strmonth = '0' + strmonth;}
                            strCollection = newStartDate.getFullYear().toString() + strmonth;
                            
                            if(isTwitter) {
                                //Add 1-6 per month
                                for(var k=1;k<7;k++)
                                {
                                     collectionRange.push(strCollection + '_' + k.toString());
                                }   
                            } else {                           
                                collectionRange.push(strCollection);
                            }
                            
                            //Perform timeslice split
                            if(timeslice == 'All')
                            {
                                //Look at next month now
                                newStartDate.setMonth(newStartDate.getMonth() + 1);      
                                if(dates.compare(newStartDate,newEndDate) > 0)
                                {
                                    //Always narrow down by date
                                    //TODO: Could be better if broke out by month query
                                    var weekQuery = "{timeColumn:{'$gte': ISODate('" + inputStartDate.toISOString() +"'), '$lte': ISODate('" + newEndDate.toISOString() +"')}}" 
                                    
                                    //all done:
                                    collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":"All", "complete":false, "tempresult":0, "result":0});
                                    collectionRange = [];
                                }                      
                            } else if(timeslice == 'Yearly')
                            {
                                var prevStartDate = new Date(newStartDate.getTime());
                                //Increment one month
                                newStartDate.setMonth(newStartDate.getMonth() + 1);   
                                //Check for year roll-over
                                if(newStartDate.getMonth == 1)
                                {
                                    //narrow down by day if in the same year
                                    //TODO: Could be better if broke out by query
                                    var weekQuery = '';
                                    if(inputStartDate.getFullYear() == prevStartDate.getFullYear() || prevStartDate.getFullYear() == newEndDate.getFullYear())
                                    {
                                        weekQuery = "{timeColumn:{";
                                        var setFirst = false;
                                        if(inputStartDate.getMonth() == prevStartDate.getMonth())
                                        {
                                            weekQuery += "'$gte': ISODate('" + inputStartDate.toISOString() +"')";
                                            setFirst = true;
                                        }
                                        if(prevStartDate.getMonth() == newEndDate.getMonth())
                                        {
                                            if(setFirst) {weekQuery +=",";}
                                            weekQuery += "'$lte': ISODate('" + newEndDate.toISOString() +"')";
                                        }
                                        weekQuery += "}}";
                                    }
                                    
                                    //at end of year:
                                    var sliceText = newStartDate.getFullYear().toString();
                                    collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":sliceText, "complete":false, "tempresult":0, "result":0});
                                    collectionRange = [];
                                }                                    
                            
                            } else if(timeslice == 'Monthly')
                            {
                                var sliceText = (newStartDate.getMonth()+1) + "/" + newStartDate.getFullYear();
                                
                                //narrow down by day if in the same month
                                var weekQuery = '';
                                if(inputStartDate.getMonth() == newStartDate.getMonth() || newStartDate.getMonth() == newEndDate.getMonth())
                                {
                                    weekQuery = "{timeColumn:{";
                                    var setFirst = false;
                                    if(inputStartDate.getMonth() == newStartDate.getMonth())
                                    {
                                        weekQuery += "'$gte': ISODate('" + inputStartDate.toISOString() +"')";
                                        setFirst = true;
                                    }
                                    if(newStartDate.getMonth() == newEndDate.getMonth())
                                    {
                                        if(setFirst) {weekQuery +=",";}
                                        weekQuery += "'$lte': ISODate('" + newEndDate.toISOString() +"')";
                                    }
                                    weekQuery += "}}";
                                }

                                collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":sliceText, "complete":false, "tempresult":0, "result":0});
                                collectionRange = [];
                                //Increment one month
                                newStartDate.setMonth(newStartDate.getMonth() + 1);                  
                            } else if(timeslice == 'Weekly')
                            {
                                var prevStartDate = new Date(newStartDate.getTime());
                                var checkDate = new Date(newStartDate.getTime());
                                var countShift = 0;
                                //Cycle for 7 days, or until the end, or until the month changes
                                while(dates.compare(checkDate,newEndDate) <= 0 && countShift < 8 && checkDate.getMonth() == newStartDate.getMonth())
                                {
                                    countShift++;
                                    checkDate.setDate(checkDate.getDate() + 1);
                                }
                                if(countShift == 8)
                                {
                                    //Successfully counted 7 days to shift will not change month or go past end of compare time
                                    newStartDate.setDate(newStartDate.getDate() + 7);
                                } else {
                                    //back up one day from countShift because that day failed a test
                                    newStartDate.setDate(newStartDate.getDate() + countShift-1);                                    
                                }
                                                                
                                var sliceText = prevStartDate.toLocaleDateString() + " to " + newStartDate.toLocaleDateString();
                                var weekQuery = "{timeColumn:{'$gte': ISODate('" + prevStartDate.toISOString() +"'), '$lte': ISODate('" + newStartDate.toISOString() +"')}}" 
                                collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":sliceText, "complete":false, "tempresult":0, "result":0});
                                collectionRange = [];
                                
                                //Add one more day
                                newStartDate.setDate(newStartDate.getDate() + 1);   
                            } else if(timeslice == 'Daily')
                            {
                            
                                var nextStartDate = new Date(newStartDate.getTime());
                                //Push to end of day
                                nextStartDate.setHours(23);
                                nextStartDate.setMinutes(59);
                                nextStartDate.setSeconds(59);
                                nextStartDate.setMilliseconds(999);
                                
                                var sliceText = newStartDate.toLocaleDateString();
                                var weekQuery = "{timeColumn:{'$gte': ISODate('" + newStartDate.toISOString() +"'), '$lte': ISODate('" + nextStartDate.toISOString() +"')}}" 
                                collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":sliceText, "complete":false, "tempresult":0, "result":0});
                                collectionRange = [];
                                
                                //Add one more day
                                newStartDate.setDate(newStartDate.getDate() + 1);  
                            }
                        }
                        
                        console.log(collectionRanges);
                        if(collectionRanges.length == 0)
                        {
                            return false;
                        } else {
                            return true;
                        }
                        
                    };
                    
                    //Handle breaking down the query into different collections
                    function nextQuery() {
                        if(collectionRanges.length > collectionGroup)
                        {
                            collectionInc++;
                            if(collectionRanges[collectionGroup]['range'].length > collectionInc)
                            {
                                step = -1;//reset Step - will be incremented later
                                request = {"query":query,"collection":collectionRanges[collectionGroup]['range'][collectionInc],"increment":increment,"step":step};
                                ajaxProcess();
                            } else {
                                //Complete
                                updateCount(collectionGroup,true);
                                
                                collectionGroup++;
                                
                                //Check if more groups
                                if(collectionGroup < collectionRanges.length)
                                {
                                    //Reset group counters
                                    step = -1;//reset Step - will be incremented later
                                    collectionInc = 0;
                                    currentCount = 0;
                                    
                                    request = {"query":query,"collection":collectionRanges[collectionGroup]['range'][collectionInc],"increment":increment,"step":step};
                                    
                                    ajaxProcess();
                                }
                            }
                        }
                        
                    };
                    
                    //Callback from success of AJAX call
                    function process(response) {
                        //{"success":'true', "totalcount" : totalcount};
                        if(response['success'] == 'true')
                        {
                            currentCount = currentCount + response['totalcount'];
                            updateCount(collectionGroup,false);
                        }
                        if(response['totalcount'] > 0)
                        {
                            //Call again
                            ajaxProcess();
                        } else {
                            nextQuery();
                        }
                    };
                    
                    //Cycle through steps until result total is 0
                    function ajaxProcess() {
                        request['step'] = request['step'] + 1;
                        ajaxQuery = $.ajax({
                            url: scriptLocation,
                            type: "post",
                            data: JSON.stringify(request),
                            dataType: "json",
                            success: process
                        });
                    };
                }

                
                


            });//end READY FUNCTION
            window.no_ajax = true;
            </script>
            <style>
            .hidden {
              display:none;
            }
            </style>
            <script src='plugins/datatables/jquery.dataTables.js'></script>
            <script src='plugins/datatables/ZeroClipboard.js'></script>
            <script src='plugins/datatables/TableTools.js'></script>
            <script src='plugins/datatables/dataTables.colReorder.min.js'></script>
            <script src='plugins/datatables/dataTables.bootstrap.js'></script>
            <script src='plugins/select2/select2.min.js'></script>
            <script src='plugins/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.min.js'></script>
        </div>
        <!--End Content-->
    </div>
</div>
<!--End Container-->
</body>
</html>
