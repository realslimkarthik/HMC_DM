
<script type="text/javascript">
function addLabelAnswer() {
    var option = document.createElement("option");
    option.text=document.labelForm.answer_text.value;
    document.labelForm.label_data.add(option);
    document.labelForm.answer_text.value = "";
};
function sortLabel(isUp) {
    if(document.labelForm.label_data.selectedIndex >= 0)
    {
        // get all options
        var shippingOptions = $('select[name=label_data] option');
        var firstidx = document.labelForm.label_data.selectedIndex;
        var secondidx;
        if(isUp)
        {
            //swap places with above one
            if(0 <= firstidx - 1)
            {
                secondidx = firstidx - 1;
            } else {
                //Do not need to shift
                return;
            }
        } else {
            //swap places with below one
            if(shippingOptions.length > firstidx + 1)
            {
                secondidx = firstidx + 1;
            } else {
                //Do not need to shift
                return;
            }
        }
        var optiontemp = shippingOptions[firstidx];
        shippingOptions[firstidx] = shippingOptions[secondidx]; 
        shippingOptions[secondidx] = optiontemp; 
        
        
        // update the select with the new option order
        $('select[name=label_data]').append(shippingOptions);
    }
};
function removeLabel() {
    if(document.labelForm.label_data.selectedIndex >= 0)
    {
        document.labelForm.label_data.remove(document.labelForm.label_data.selectedIndex);
    }
};

function checkLabelAnswer(event) {
    
    if (event.keyCode == 13) {
        event.preventDefault();
        addLabelAnswer();
    }
};
function setLabelForm(question,answerset) {
    document.labelForm.question_text.value = question;
    
    for(var i=0; i<answerset.length; i++)
    {
        var option = document.createElement("option");
        option.text=answerset[i];
        document.labelForm.label_data.add(option);
    }
    
};
function clearLabelForm() {
    document.labelForm.question_text.value = "";
    document.labelForm.answer_text.value = "";
    
    //Clear select
    var i;
    for(i=document.labelForm.label_data.options.length-1;i>=0;i--)
    {
        document.labelForm.label_data.remove(i);
    }
};
var linedata = [];
linedata.push('<form name="labelForm">');
linedata.push('    <h4>Label attributes</h4>');
linedata.push('    Question:&nbsp;<input id="question_text" type="text" name="question_text" size="40"/><br>');
linedata.push('    <hr width=100% align=left color=black>');
linedata.push('    <table width=100%>');
linedata.push('        <tr style="padding: 50px">');
linedata.push('            <td style="vertical-align: top" >');
linedata.push('                <div title="Hit enter to add answer"><input onkeydown="checkLabelAnswer(event)" type="text" name="answer_text" size="40"/></div>');
linedata.push('            </td>');
linedata.push('            <td>');
linedata.push('                <button type="button" class="btn btn-primary btn-lg" onmousedown="addLabelAnswer()">Add Answer</button>');                    
linedata.push('            </td>');
linedata.push('        </tr>');
linedata.push('    </table>');
linedata.push('    Answer List:');
linedata.push('    <table width=100% align=center>');
linedata.push('        <tr style="padding: 10px">');
linedata.push('            <td valign=center align=center style="padding: 10px">');
linedata.push('                <a onclick="sortLabel(true)"><i class="fa fa-arrow-up"></i></a><br>');
linedata.push('                <a onclick="removeLabel()"><i class="fa fa-times"></i></a><br>');
linedata.push('                <a onclick="sortLabel(false)"><i class="fa fa-arrow-down"></i></a><br>');
linedata.push('            </td>');
linedata.push('            <td>');
linedata.push('                <select size=5 name="label_data" style="width: 300px">');
linedata.push('                </select>');
linedata.push('            </td>');
linedata.push('        </tr>');
linedata.push('    </table>');
linedata.push('    <hr width=100% align=left color=black>');
linedata.push('    <table width=500>');
linedata.push('        <tr>');
linedata.push('            <td width=50% align=center>');
linedata.push('                <button type="button" class="btn btn-primary btn-lg" onmousedown="addLabel()">Apply</button>');
linedata.push('            </td>');
linedata.push('            <td width=50% align=center>');
linedata.push('                <button type="button" class="btn btn-primary btn-lg" onmousedown="toggleOverlay()">Cancel</button>');
linedata.push('            </td>');
linedata.push('        </tr>');
linedata.push('    </table>');
linedata.push('    </form>');
$('#specialBox').html(linedata.join(' '));
</script>
            <div class="row">
                <div id="breadcrumb" class="col-md-12">
                    <ol class="breadcrumb">
                        <li><a href="#">Label Data</a></li>
                    </ol>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <div class="box-name">
                                <span>Setup Labels</span>
                            </div>
                            <div class="box-icons">
                                <a class="label-to-load-csv">
                                    <i class="fa fa-upload"></i>&nbsp;Append from CSV
                                    <input type="file" id="fileUploadLabel" accept=".csv" style='display:none;'/>
                                </a>                                
                                <a class="label-to-csv">
                                    <i class="fa fa-download"></i>&nbsp;Save to CSV
                                </a>
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                            <div class="no-move"></div>
                        </div>
                        <div class="box-content">
                            <div class="row form-group">
                                <div class="col-sm-12">
                                    <a onmousedown="openLabel(-1)"><i class="fa fa-plus"></i>&nbsp;Add Label</a>&nbsp;&nbsp;&nbsp;&nbsp;
                                    <a class="remove-label"><i class="fa fa-times"></i>&nbsp;Remove Label</a>&nbsp;&nbsp;&nbsp;<i>(double-click to edit)</i>
                                    <div title="Double-click to edit">
                                        <select id="label-list" ondblclick="editLabel()" class="form-control" size="5"></select>
                                    </div>
                                    <i>Note: Labels are automatically loaded/saved to Cloud</i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <div class="box-name">
                                <span>Information</span>
                            </div>
                            <div class="box-icons">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                                <a class="close-link">
                                    <i class="fa fa-times"></i>
                                </a>
                            </div>
                            <div class="no-move"></div>
                        </div>
                        <div class="box-content no-padding table-responsive">
                            <h4>Select a file to load.</h4>
                            <h5>Column titles that include "LABEL" will be editable.</h5>
                            <h5>While editing the LABEL columns in the table you can use the keyboard to navigate cells, see below</h5>
                            <ol>
                                <li><kbd>SHIFT</kbd>+<kbd>arrow key</kbd>-Prev(Next) cell at row/col</li>
                                <li><kbd>CTRL</kbd>+<kbd>arrow key</kbd>-First(End) cell at col ONLY</li>
                                <li><kbd>Enter/Tab</kbd>-Next cell in table</li>
                            </ol>
                            <span>To search using a regular expression by column, put a "~" as the first character, and then when expression is complete press <kbd>ENTER</kbd></span>
                        </div>
                    </div>
                </div>
            </div> 
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <div class="box-name">
                                <span>Toggle columns</span>
                            </div>
                            <div class="box-icons">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                            <div class="no-move"></div>
                        </div>
                        <div id="toggleMe" class="box-content">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <div class="box-name">
                                <span>Label Data</span>
                            </div>
                            <div class="box-icons">
                                <a class="beauty-table-to-load">
                                    <i class="fa fa-cloud-download"></i>&nbsp;Temp Load
                                </a>
                                <a class="beauty-table-to-save">
                                    <i class="fa fa-cloud-upload"></i>&nbsp;Temp Save All
                                </a>
                                <a class="beauty-table-to-load-csv">
                                    <i class="fa fa-upload"></i>&nbsp;Load from CSV
                                    <input type="file" id="fileUpload"  accept=".csv" style='display:none;'/>
                                </a>                                
                                <a class="beauty-table-to-csv">
                                    <i class="fa fa-download"></i>&nbsp;Save filter to CSV
                                </a>                                
                                <a class="beauty-table-to-crop">
                                    <i class="fa fa-crop"></i>&nbsp;Crop non-Filtered
                                </a>                          
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                            <div class="no-move"></div>
                        </div>
                        <div class="box-content no-padding table-responsive">
                            <table class="table table-bordered table-striped table-hover table-heading table-datatable beauty-table-mod" id="datatable-3">  
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                                <tfoot>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <script type="text/javascript">
            function MakeSelect2(){
                //$('select').select2();
                $('.dataTables_filter').each(function(){
                    $(this).find('label input[type=text]').attr('placeholder', 'Search');
                });
            }
            
            //Global window.labelData
            window.labelData = [];
            
            //Currently editing label index in window.labelData
            var currentEditLabel = -1;
            
            //Update the list based on window.labelData
            function updateLabelList(){
                //remove all remaining list items
                //Clear select
                var i;
                for(i=document.getElementById('label-list').options.length-1;i>=0;i--)
                {
                    document.getElementById('label-list').remove(i);
                }

                var newoptions = [];
                var oneopt;
                var i;
                for(i=0; i<window.labelData.length; i++)
                {
                    var str = window.labelData[i]["question"] + "? (";
                    for(j=0; j<window.labelData[i]["answerset"].length; j++)
                    {
                        if(j>0) {str+=", ";}
                        str += window.labelData[i]["answerset"][j];
                    }
                    oneopt = document.createElement("option");
                    oneopt.text=str + ")";
                    //newoptions.push(oneopt);
                    document.getElementById('label-list').add(oneopt);
                }
                //Save
                saveToStorage();
            };
            
            //Submit Add/Edit label defined in label set (might already be editted)
            function addLabel(){
                //pull all options into an array
                var shippingOptions = document.labelForm.label_data.options;
                
                //Convert option array to text array
                var textoptions = [];
                for(var i=0; i<shippingOptions.length; i++)
                {
                    textoptions[i] = shippingOptions[i].text;
                }
                
                var question = document.labelForm.question_text.value;
                
                if(currentEditLabel >= 0)
                {
                    //replace
                    window.labelData[currentEditLabel] = { "question" : question,
                                              "answerset" : textoptions};
                } else {
                    //Add new
                    window.labelData[window.labelData.length] = { "question" : question,
                                                    "answerset" : textoptions};
                }
                
                //call update of select based on window.labelData
                updateLabelList();
                
                toggleOverlay();
                
            };
            
            //Open label add/edit display
            function openLabel(editNumber) {
                
                clearLabelForm();
                
                if(editNumber >= 0 && window.labelData.length > editNumber)
                {
                    currentEditLabel = editNumber;
                    setLabelForm(window.labelData[editNumber]["question"],window.labelData[editNumber]["answerset"]);
                } else {
                    currentEditLabel = -1;
                }
                
                toggleOverlay();
                
                //Focus after update
                setTimeout ( function () {
                    /* show the cursor */
                    $('#question_text').focus();
                }, 100);
            };

            //Edit label
            function editLabel() {
                if(document.getElementById('label-list').selectedIndex >= 0)
                {
                    openLabel(document.getElementById('label-list').selectedIndex);
                }
            }
            $('.edit-label').on('click', editLabel);
            
            //Remove label
            $('.remove-label').on('click', function(){
                if(document.getElementById('label-list').selectedIndex >= 0)
                {
                     var removeidx = document.getElementById('label-list').selectedIndex;

                    //remove from array
                    window.labelData.splice(removeidx,1);
                }
                
                //Update display to match
                updateLabelList();
            });

            //Save the label setup to persistant location in browswer
            function saveToStorage() {
                localStorage.setItem('window.labelData',JSON.stringify(window.labelData));
            };
            
            function loadFromStorage() {
                if(!localStorage.getItem('window.labelData'))
                {
                } else {
                    window.labelData = JSON.parse(localStorage.getItem('window.labelData'));
                    updateLabelList();
                }
            };
            

            $(document).ready(function() {
                // Load Datatables and run plugin on tables 
                TestTable3(true);//true means Label
                
                // Add Drag-n-Drop feature
                WinMove();
                
                loadFromStorage();
                
                
                //DOWNLOAD BUTTON
                $('.label-to-csv').on('click', function(e){
                    e.preventDefault();
                    
                    //Temporary solution - change to save to CSV and load CSV
                    //var result_json = JSON.stringify(window.labelData);
                    //OpenModalBox('Table to JSON values', result_json);
                    var headerdata = ['question'];
                    var data = [];
                    var maxlength= 0;
                    if(window.labelData.length == 0) {return;}//stop if no data
                    for(var i=0;i<window.labelData.length;i++)
                    {
                        //Find max length
                        if(window.labelData[i]['answerset'].length > maxlength)
                        {
                            maxlength = window.labelData[i]['answerset'].length;
                        }
                        
                    } 
                    for(var i=0; i<maxlength; i++)
                    {
                        headerdata.push('answer' + (i+1));
                    }
                    for(var i=0;i<window.labelData.length;i++)
                    {
                        data[i] = [window.labelData[i]['question']];
                        var alen = window.labelData[i]['answerset'].length;
                        for(var j=0; j<alen; j++)
                        {
                            data[i][j+1] = window.labelData[i]['answerset'][j];
                        }
                        //Pack in empty set to make it max columns
                        for(var k=0; k<maxlength - alen; k++)
                        {
                            data[i][alen+k+1] = "";//shift by one for question
                        }
                    }                    
                    
                    //Add Header row
                    var alldata = [headerdata].concat(data);
                    var csvdata = $.csv.fromArrays(alldata,{'experimental':true});
                    var blob = new Blob([csvdata], {type: "text/csv;charset=utf-8"});
                    saveAs(blob, 'labelset.csv');
                });
                
                
                
                //Setup Upload of Label
                var fileUploadLabel = document.getElementById("fileUploadLabel");
            
                fileUploadLabel.addEventListener('change', function(e) {
                    var file = fileUploadLabel.files[0];
                    var reader = new FileReader();
            
            
                    reader.onload = function(e) {
                        //DO NOT NEED:
                        //fileUploadLabel.disabled = true;
                        
                        var headerrow = [];
                        dataSet = $.csv.toArrays(e.target.result);
                        if(dataSet.length == 0 || dataSet[0].length == 0)
                        {
                            //No data, so return
                            return;
                        }
                        var headerdata = dataSet[0];            

                        //DO NOT NEED
//                         if(headerdata.length > 0) {
//                             for(var i = 0; i<headerdata.length; i++) {
//                             }
//                         }
                        
                        dataSet.shift();//remove header row
            
                        dataSet.forEach(function(l){
                            var maxlabel = window.labelData.length;
                            var qq = l[0];
                            l.shift();//remove first element
                            for(var kk=0; kk<l.length; kk++)
                            {
                                if(l[kk] == "")
                                {
                                    l.splice(kk);//remove all remaining blanks
                                    break;
                                }
                            }
                            window.labelData[maxlabel] = {"question": qq, "answerset":l};
                        });
                        updateLabelList();
                    };
        
                    //console.log("Starting upload");
                    reader.readAsText(file);
                });
        
                //BROWSWER LOAD BUTTON
                $('.beauty-table-to-load').on('click', function(e){
                    if(window.notLoadedDataTable)
                    {
                        
                        if(!localStorage.getItem('dataTable'))
                        {
                            console.log('Tried to load, but no data');
                        } else {
                            var jsondata = decodeURIComponent(localStorage.getItem('dataTable'));
                            var filename = localStorage.getItem('filename');
                            var viscol = JSON.parse(localStorage.getItem('viscol'));
                            setupDataTable(JSON.parse(jsondata),filename,viscol);
                            console.log('Tried to load, with data');
                            
                            //Disable fileUpload to not load anything
                            var fileUpload = document.getElementById("fileUpload");
                            fileUpload.disabled = true;
                            $('.beauty-table-to-load').hide();
                            $('.beauty-table-to-load-csv').hide();
                        }
                    }
                });
                
                //BROWSWER LOAD BUTTON
                $('.beauty-table-to-load-csv').on('click', function(e){
                    if(window.notLoadedDataTable)
                    {
                        var fileUpload = document.getElementById("fileUpload");
                        fileUpload.click();
                    }
                });
                
                
                //LABEL LOAD BUTTON
                $('.label-to-load-csv').on('click', function(e){
                    var fileUploadLabel = document.getElementById("fileUploadLabel");
                    fileUploadLabel.click();
                });
                
                //Initially hide the options
                $('.beauty-table-to-save').hide();
                $('.beauty-table-to-csv').hide();
                $('.beauty-table-to-crop').hide();

                //Hide temp load if nothing to load
                if(!localStorage.getItem('dataTable'))
                {
                   $('.beauty-table-to-load').hide();
                }
            });//end READY FUNCTION
            window.no_ajax = true;
            window.notLoadedDataTable = true;
            </script>
            <style>
            .hidden {
              display:none;
            }
            </style>
            <script src='plugins/datatables/jquery.dataTables.min.js'></script>
            <script src='plugins/datatables/ZeroClipboard.js'></script>
            <script src='plugins/datatables/TableTools.js'></script>
            <script src='plugins/datatables/dataTables.colReorder.min.js'></script>
            <script src='plugins/datatables/dataTables.fixedColumns.min.js'></script>
            <script src='plugins/datatables/dataTables.bootstrap.js'></script>
            <script src='plugins/select2/select2.min.js'></script>
            <script src='plugins/bloodhound/bloodhound.min.js'></script>
            <script src='plugins/bloodhound/typeahead.jquery.min.js'></script>
