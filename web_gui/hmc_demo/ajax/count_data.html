            <div class="row">
                <div id="breadcrumb" class="col-md-12">
                    <ol class="breadcrumb">
                        <li><a href="#">Count Data</a></li>
                    </ol>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <div class="box-name">
                                <span>Setup Query</span>
                            </div>
                            <div class="box-icons">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                            <div class="no-move"></div>
                        </div>
                        <div class="box-content">
                            <form id="queryform" class="form-horizontal">
                                <div class="form-group has-success">
                                    <label class="col-sm-2 control-label">Include Tags/Rules</label>
                                    <div class="col-sm-4">
                                        <select id="tagInc" multiple="multiple" class="populate placeholder s2_with_tag"></select>
                                    </div>
                                    <div class="col-sm-4">
                                        <select id="ruleInc" multiple="multiple" class="populate placeholder s2_with_rule"></select>
                                    </div>
                                </div>
                                <div class="form-group has-error">
                                    <label class="col-sm-2 control-label">Exclude Tags/Rules</label>
                                    <div class="col-sm-4">
                                        <select id="tagExc" multiple="multiple" class="populate placeholder s2_with_tag"></select>
                                    </div>
                                    <div class="col-sm-4">
                                        <select id="ruleExc" multiple="multiple" class="populate placeholder s2_with_rule"></select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-2" align='right'>
                                        <div class="checkbox-inline">
                                            <label>
                                                <input type="checkbox" id='querycheck'> Use Query:
                                                <i class="fa fa-square-o"></i>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-sm-8">
                                        <input name='querystring' class="form-control" type="text" id="query" placeholder="e.g. {'mrt' : {'$ne': 7}}" data-toggle="tooltip" data-placement="top" title="JSON query directly to Mongo.  (mrt=Tags, mrv=Rules, $ne=Not Include, $eq=Includes)"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Date period</label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" id="datestart" placeholder="Date period">
                                    </div>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" id="dateend" placeholder="Date period">
                                    </div>
                                    <div class="col-sm-4">
                                        <label class="control-label">Time Slice</label>
                                        <select id="timeSlice">
                                            <option selected>All</option>
                                            <option>Yearly</option>
                                            <option>Monthly</option>
                                            <option>Weekly</option>
                                            <option>Daily</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-2" align='right'>
                                        <button type='button' id="submitQuery" class="btn btn-default btn-label-left">
                                            <span><i class="fa fa-rocket txt-danger"></i></span>
                                                Run Query
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <div class="box-name">
                                <span>Query Results</span>
                            </div>
                            <div class="box-icons">                
                                <a class="label-to-csv">
                                    <i class="fa fa-download"></i>&nbsp;Save to CSV
                                </a>
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                            <div class="no-move"></div>
                        </div>
                        <div class="box-content">
                            <div id="morris-chart-1" style="height: 400px;"></div>
                            <div id="response">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script type="text/javascript" src="input/testdata.js"></script>
            <script type="text/javascript">
            function addRulesTags() {
                var output = [];
                $.each(tw_rules, function(key, value)
                {
                  output.push('<option value='+ value +'>'+ key +'</option>');
                });
                $('.s2_with_rule').html(output.join(''));
                
                output = [];
                $.each(tw_tags, function(key, value)
                {
                  output.push('<option value='+ value +'>'+ key +'</option>');
                });
                $('.s2_with_tag').html(output.join(''));
                
                MakeSelect2();
            }
            
            function simple_moving_averager(period) {
                var nums = [];
                return function(num) {
                    nums.push(num);
                    if (nums.length > period)
                        nums.splice(0,1);  // remove the first element of the array
                    var sum = 0;
                    for (var i in nums)
                        sum += nums[i];
                    var n = period;
                    if (nums.length < period)
                        n = nums.length;
                    return(sum/n);
                }
            }
             //EXAMPLE OF SMA above
//             var sma3 = simple_moving_averager(3);
//             var sma5 = simple_moving_averager(5);
//             var data = [1,2,3,4,5,5,4,3,2,1];
//             for (var i in data) {
//                 var n = data[i];
//                 // using WSH
//                 WScript.Echo("Next number = " + n + ", SMA_3 = " + sma3(n) + ", SMA_5 = " + sma5(n));
//             }
            
            
            
            function isJSON (jsonString){
                try {
                    var o = JSON.parse(jsonString);
            
                    // Handle non-exception-throwing cases:
                    // Neither JSON.parse(false) or JSON.parse(1234) throw errors, hence the type-checking,
                    // but... JSON.parse(null) returns 'null', and typeof null === "object", 
                    // so we must check for that, too.
                    if (o && typeof o === "object" && o !== null) {
                        return true;
                    }
                }
                catch (e) { }
            
                return false;
            };

            function MakeSelect2(){                
                $('.s2_with_tag').select2({placeholder: "Select Tags"});
                $('.s2_with_rule').select2({placeholder: "Select Rules"});
            }
                
            function setupDatePeriod()
            {
                $('#datestart').datepicker({
                    defaultDate: "+lw",
                    changeMonth: true,
                    changeYear: true,
                    numberOfMonths: 1,
                    maxDate: '0',//set to +0 days from current date
                    minDate: new Date('January 1, 2013 00:00:00'), //set to 1/2013
                    onClose: function( selectedDate ) {
                        $( "#dateend" ).datepicker( "option", "minDate", selectedDate );
                        if($( "#dateend" ).val() == '')
                        {
                            $( "#dateend" ).val(selectedDate);
                        }
                    }
                });
                $('#dateend').datepicker({
                    defaultDate: "+lw",
                    changeMonth: true,
                    changeYear: true,
                    numberOfMonths: 1,
                    maxDate: '0',//set to +0 days from current date
                    minDate: new Date('January 1, 2013 00:00:00'), //set to 1/2013
                    onClose: function( selectedDate ) {
                        $( "#datestart" ).datepicker( "option", "maxDate", selectedDate );
                        if($( "#datestart" ).val() == '')
                        {
                            $( "#datestart" ).val(selectedDate);
                        }
                    }
                });
            };

            $(document).ready(function() {
                setupDatePeriod();
                addRulesTags();
                // Add Drag-n-Drop feature
                WinMove();
                var queryStarted = false;//Allow only one query to be going on at a time
                var queryString = "";
                $('#submitQuery').on('click', function(e) {
                    if(!queryStarted)
                    {
                        var isquery = $('#querycheck').is(':checked');
                        var query = {};
                        var error = false;
                        queryString = "";
                        if(isquery)
                        {
                            var querytext = $('#query').val();
                            queryString += "Query=" + querytext;
                            var newtext = querytext.replace(/'/g,'"');
                            //Validate querytext if is JSON
                            if(!isJSON(newtext))
                            {
                                OpenModalBox('Form Error', 'Bad query: it is not a JSON');
                                error = true;
                            }                            
                            query = JSON.parse(newtext);
                        } else {
                            queryString += "Query=";
                            var selectedValuesTagInc = [];
                            var selectedValuesTagExc = [];
                            var selectedValuesRuleInc = [];
                            var selectedValuesRuleExc = [];
                            //Not using query, so form the query
                            //Convert string values to integers
                            $('#tagInc :selected').each(function(i, selected){ 
                                selectedValuesTagInc.push(parseInt($(selected).val()));
                                queryString += "+tag#" + $(selected).val();
                            });
                            $('#tagExc :selected').each(function(i, selected){ 
                                selectedValuesTagInc.push(parseInt($(selected).val()));
                                queryString += "-tag#" + $(selected).val();
                            });
                            $('#ruleInc :selected').each(function(i, selected){ 
                                selectedValuesRuleInc.push(parseInt($(selected).val()));
                                queryString += "+rule#" + $(selected).val();
                            });
                            $('#ruleExc :selected').each(function(i, selected){ 
                                selectedValuesRuleExc.push(parseInt($(selected).val()));
                                queryString += "-rule#" + $(selected).val();
                            });
                            
                            //Only add to query if not empty
                            if(selectedValuesTagInc.length > 0 || selectedValuesTagExc.length > 0)
                            {
                                query[searchtag]= {};
                                if(selectedValuesTagInc.length > 0)
                                {
                                    query[searchtag]['$in']= selectedValuesTagInc;
                                }
                                if(selectedValuesTagExc.length > 0)
                                {
                                    query[searchtag]['$nin']= selectedValuesTagExc;
                                }
                            }
                            if(selectedValuesRuleInc.length > 0 || selectedValuesRuleExc.length > 0)
                            {
                                query[searchrule]= {};
                                if(selectedValuesRuleInc.length > 0)
                                {
                                    query[searchrule]['$in']= selectedValuesRuleInc;
                                }
                                if(selectedValuesRuleExc.length > 0)
                                {
                                    query[searchrule]['$nin']= selectedValuesRuleExc;
                                }
                            }
                            
                        }
                        
                        if(error == false)
                        {      
                            var datestart = $('#datestart').val();
                            var dateend = $('#dateend').val();
                            
                            if(datestart == '' || dateend == '')
                            {
                                OpenModalBox('Form Error', 'Bad date start/end: must be filled in');
                            } else {
                                //convert all single ' to "
                                var timeslice = $('#timeSlice').val();
                                queryString += "   Dates=" + datestart.replace('/','-') + " to " + dateend.replace('/','-') + " by " + timeslice;
                                queryStarted = true;
                                countData(query,datestart,dateend,timeslice);
                            }
                        }
                    }
                });
                
                
                
                //Constants:
                //var searchtag = "matchingrulestag";
                var searchtag = "mrt";//abreviated name
                //var searchrule = "matchingrulesvalue"; //by number
                var searchrule = "mrv"; //abreviated name
                //var dataColumns = ["Idpost","bodypost","retweetCount","generatordname","filterlevel","kloutscore","matchingrulestag1","matchingrulestag2","matchingrulestag3","matchingrulestag4","matchingrulestag5","matchingrulestag6","matchingrulesvalues","matchingrulesvalue1","matchingrulesvalue2","matchingrulesvalue3","matchingrulesvalue4","matchingrulesvalue5","matchingrulesvalue6","languagevalue","favoritesCount","objpostedTime","objsummary","objlink","objid","objobjType","bodyoriginal","actorpreferredusername","actorname","actorlinkshref","actorTimeZone","actorimage","actorverified","actorstatusuesCount","actorsummary","actorlanguages","actorutcOffset","actorlink","actorfollowersCount","actorfavoritesCount","actorfriendsCount","actorlistedCount","actorPostedTime","actorid","actorObjType","entitiesusrmentionsidstr1","entitiesusrmentionssname1","entitiesusrmentionsname1","entitiesusrmentionsidstr2","entitiesusrmentionssname2","entitiesusrmentionsname2","entitiesusrmentionsidstr3","entitiesusrmentionssname3","entitiesusrmentionsname3","entitiesusrmentionsidstr4","entitiesusrmentionssname4","entitiesusrmentionsname4","entitiesusrmentionsidstr5","entitiesusrmentionssname5","entitiesusrmentionsname5","entitieshtagstext1","entitieshtagstext2","entitieshtagstext3","entitieshtagstext4","entitieshtagstext5","entitiesurlexpandedurl","entitiesmdaexpandedurl","lang","postedTime","Year","Month","Day","Time","objgeotype","objlocdname","geotype","geocoordinates","verb","link","locdname","locname","loctwcountrycode","loccountrycode","locgeocoordinates","gniplocdname","gniploccountry","gniplocregion","gniploccounty","gniploclocality","gniplocgeocoordinates","gnipurl","gnipexpandedurl"];
                //var timeColumn = "postedTime";//full name
                var timeColumn = "pt";//abreviated name
                
                //Start a pull of count data
                function countData(query,datestart,dateend,timeslice) /*sTag,sRule,sTimeStart,sTimeEnd,sSplice*/
                {                  
                    var dddData = {};
                    var chart = null;
                    var isTwitter = true;//temp  
                    var currentCount = 0;
                    var ajaxQuery;
                    //var query = {};
                    var collectionRanges = [];
                    var collectionGroup = 0;
                    var collectionInc = -1;//Will be incremented on first call
                    //query = {'mrt' : {'$ne': 7}};
                    
                    //collectionRange = [datestart, dateend];
                    var increment = 100000;
                    var step = -1;//Will be incremented on first call
                    //var query = {"sTag":sTag,"sRule":sRule,"sTimeStart" :sTimeStart, "sTimeEnd":sTimeEnd, "sSplice":sSplice};
                    var request = {};
                    
                    //var scriptLocation = "http://localhost:8000/cgi-bin/test_cgi.py";
                    //var scriptLocation = "http://10.177.54.27:8080/db.json";
                    var scriptLocation = "http://ihrp-hmc:8080/db.json";
                    var startquerydate = new Date();//gets current time
                    var lastdate = new Date();
                    var sma = simple_moving_averager(5);
                    
                    
                    //Setup query
                    if(!setupQuery(datestart,dateend,timeslice))
                    {
                        OpenModalBox('Form Error', 'Resulted in no query data');
                        return null;
                    }
                    
                    
                    $('#response').html('<h4>Started query</h4> <button type="button" id="endquery" class="btn btn-danger btn-app-sm"><i class="fa fa-spinner fa-spin"></i></button><br><h6 id="updatetime"></h4><div class="progress progress-striped active"><div class="progress-bar progress-bar-danger" id="thebar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"><span id="textbar">0% Complete</span></div></div>');

                    //Create plot after setup done
                    plotData();
                    
                    //Start the cycle
                    nextQuery();
                    
                    
                    
                    $('#endquery').on('click',function ()
                    {
                        ajaxQuery.abort();
                        $('#response').html("<h4>QUERY CANCELLED</h4>");    
                        queryStarted = false;
                    });
                    
                    function completeUpdate()
                    {
                        var newdate = new Date();//gets current time
                        var diffdate = newdate.getTime() - startquerydate.getTime();
                        diffdate /= 1000;
                        $('#response').html("<h4>QUERY COMPLETE</h4><br>Total Elapsed Seconds: " + diffdate);  
                        queryStarted = false;
                    };
                    
                    $('.label-to-csv').show()
                    $('.label-to-csv').off('click.all');
                    $('.label-to-csv').on('click.all', savePlot);
                    function savePlot(){
                        var data = [];
                        //Create header
                        var temp = [];
                        for(var i=0;i<collectionRanges.length;i++)
                        {
                            if(collectionRanges[i]['complete'])
                            {
                                temp.push(collectionRanges[i]['slice']);
                            } else {
                                temp.push(collectionRanges[i]['slice'] + " (incomplete result)");
                            }
                        }
                        data.push(temp);
                        temp = [];
                        for(var i=0;i<collectionRanges.length;i++)
                        {
                            //Only save final results
                            if(collectionRanges[i]['complete'])
                            {
                                temp.push(collectionRanges[i]['result'].toString());
                            } else {
                                temp.push(collectionRanges[i]['tempresult'].toString());
                            }
                        }            
                        data.push(temp);        
                        
                        //Add Header row
                        var csvdata = $.csv.fromArrays(data,{'experimental':true});
                        var blob = new Blob([csvdata], {type: "text/csv;charset=utf-8"});
                        saveAs(blob, queryString + '.csv');
                    };
                    
                    //Plots the data
                    function plotData()
                    {
                        $('#morris-chart-1').empty();//destroy previous
                        var colors = ['#A30000','#038C2C'];
                        //Do not allow a re-plot setup
                        if(chart == null)
                        {  
                            chart = Morris.Bar({
                                element: 'morris-chart-1',
                                data: collectionRanges,
                                xkey: 'slice',
                                ykeys: ['tempresult', 'result'],
                                labels: ['Updating Count', 'Complete Count'],
                                hideHover: 'auto',
                                barColors: colors,
                                stacked: true,
                                resize: true,
                                hoverCallback: function(index, options, content) {
                                    var data = options.data[index];
                                    var stringName = 'Count: ';
                                    var outstr =  '<div style="color:';
                                    if(collectionRanges[index]['complete'])
                                    {
                                        outstr += colors[1] + '">' + collectionRanges[index]['slice'] + '<br>'+ stringName;
                                        outstr += data.result.toLocaleString();
                                    } else {
                                        outstr += colors[0] + '">' + collectionRanges[index]['slice'] + '<br>'+ stringName;
                                        outstr += data.tempresult.toLocaleString();
                                    }
                                    outstr += '</div>';
                                    return outstr;
                                },
                                xLabelAngle: 60
                            });
                        }
                    };
                    
                    function updatePlot()
                    {
                        chart.setData(collectionRanges);
                    };
                    
                    var currentpercent = 0;
                    var estimatestr = "";//allow old times to be there
                    //Update display of count
                    function updateCount(group,finalUpdate)
                    {
                        var newdate = new Date();//gets current time
                        if(finalUpdate)
                        {
                            collectionRanges[group]['result'] = currentCount;
                            collectionRanges[group]['tempresult'] = 0;
                            collectionRanges[group]['complete'] = true;
                            updatePlot();
                            
                            //Calculate estimate by simple moving average (last 5)
                            var diffdateprev = newdate.getTime() - lastdate.getTime();
                            diffdateprev /= 1000;
                            var avg = sma(diffdateprev);
                            var numleft = collectionRanges.length - group + 1;//group starts at 0
                            var estimate = avg*numleft;
                            estimate = Math.round(estimate*100)/100;//2 decimal places
                            currentpercent = Math.floor(100*(group + 1)/collectionRanges.length);//assume every step is equal
                            estimatestr = "<br>Seconds Estimate Left: " + estimate;
                            //console.log("Finished group");
                        } else {
                            collectionRanges[group]['tempresult'] = currentCount;
                            currentpercent = Math.floor(100*(collectionInc+1)/collectionRanges.length/collectionRanges[group]['range'].length + 100*(group)/collectionRanges.length);//assume all are equal
                            
                            updatePlot();
                            //console.log("Finished segment");
                        }
                        //Update progress bar
                        $('#thebar').css('width', currentpercent+'%').attr('aria-valuenow', currentpercent);
                        $('#textbar').html(currentpercent + "% Complete");
                        
                        var diffdate = newdate.getTime() - startquerydate.getTime();
                        diffdate /= 1000;
                        $('#updatetime').html("Last updated: " + newdate.toUTCString() + "<br>Total Elapsed Seconds: " + diffdate + estimatestr);
                    };
                    
                    //Setup all query information
                    function setupQuery(datestart,dateend,timeslice) {
                        
                        var collectionRange = [];
                        var inputStartDate = new Date(datestart);
                        //Set to beginning of day
                        inputStartDate.setHours(0);
                        inputStartDate.setMinutes(0);
                        inputStartDate.setSeconds(0);
                        inputStartDate.setMilliseconds(0);
                        var newStartDate = new Date(inputStartDate.getTime());
                        //Only set to first of month if doing monthly incrementing
                        if(timeslice == 'All' || timeslice == 'Yearly' || timeslice == 'Monthly')
                        {
                            newStartDate.setDate(1);//make the 1st of the month so +1 on month works correctly
                        }
                        var newEndDate = new Date(dateend);
                        //Push to end of day
                        newEndDate.setHours(23);
                        newEndDate.setMinutes(59);
                        newEndDate.setSeconds(59);
                        newEndDate.setMilliseconds(999);
                        var currentWeek = 0;
                        var currentDay = 0;
                        
                        while(dates.compare(newStartDate,newEndDate) <= 0)
                        {
                            var strmonth = (newStartDate.getMonth() + 1).toString();
                            if(strmonth.length < 2) { strmonth = '0' + strmonth;}
                            strCollection = newStartDate.getFullYear().toString() + strmonth;
                            
                            if(isTwitter) {
                                //Add 1-6 per month
                                for(var k=1;k<7;k++)
                                {
                                     collectionRange.push(strCollection + '_' + k.toString());
                                }   
                            } else {                           
                                collectionRange.push(strCollection);
                            }
                            
                            //Perform timeslice split
                            if(timeslice == 'All')
                            {
                                //Look at next month now
                                newStartDate.setMonth(newStartDate.getMonth() + 1);      
                                if(dates.compare(newStartDate,newEndDate) > 0)
                                {
                                    //Always narrow down by date
                                    //TODO: Could be better if broke out by month query
                                    var weekQuery = {};
                                    weekQuery[timeColumn] = {'$gte': inputStartDate.toISOString() , '$lte': newEndDate.toISOString() }; 
                                    
                                    //all done:
                                    collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":"All", "complete":false, "tempresult":0, "result":0});
                                    collectionRange = [];
                                }                      
                            } else if(timeslice == 'Yearly')
                            {
                                var prevStartDate = new Date(newStartDate.getTime());
                                //Increment one month
                                newStartDate.setMonth(newStartDate.getMonth() + 1);   
                                //Check for year roll-over, or end of time period
                                if(newStartDate.getMonth() == 0 || dates.compare(newStartDate,newEndDate) > 0)
                                {
                                    prevStartDate.setMonth(newStartDate.getMonth() + 1);
                                    prevStartDate.setDate( prevStartDate.getDate() - 1);//Backup to end of month
                                    //Set end of day on last day
                                    prevStartDate.setHours(23);
                                    prevStartDate.setMinutes(59);
                                    prevStartDate.setSeconds(59);
                                    prevStartDate.setMilliseconds(999);
                                    //narrow down by day if in the same year
                                    //TODO: Could be better if broke out by query
                                    var weekQuery = {};
                                    if(inputStartDate.getFullYear() == prevStartDate.getFullYear() || prevStartDate.getFullYear() == newEndDate.getFullYear())
                                    {
                                        var tempWeekGT = {};
                                        var tempWeekLT = {};
                                        if(inputStartDate.getFullYear() == prevStartDate.getFullYear())
                                        {
                                            tempWeekGT = {'$gte': inputStartDate.toISOString()};  
                                        }
                                        if(prevStartDate.getFullYear() == newEndDate.getFullYear())
                                        {
                                            tempWeekLT = {'$lte': newEndDate.toISOString()};  
                                        }
                                        var tempquery = $.extend({}, tempWeekGT, tempWeekLT);
                                        weekQuery[timeColumn] = tempquery;
                                    }
                                    
                                    //at end of year:
                                    var sliceText = prevStartDate.getFullYear().toString();
                                    collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":sliceText, "complete":false, "tempresult":0, "result":0});
                                    collectionRange = [];
                                }                                    
                            
                            } else if(timeslice == 'Monthly')
                            {
                                var sliceText = (newStartDate.getMonth()+1) + "/" + newStartDate.getFullYear();
                                
                                //narrow down by day if in the same month
                                var weekQuery = {};
                                if(inputStartDate.getMonth() == newStartDate.getMonth() || newStartDate.getMonth() == newEndDate.getMonth())
                                {
                                    var tempWeekGT = {};
                                    var tempWeekLT = {};
                                    if(inputStartDate.getMonth() == newStartDate.getMonth())
                                    {
                                        tempWeekGT = {'$gte': inputStartDate.toISOString()};  
                                    }
                                    if(newStartDate.getMonth() == newEndDate.getMonth())
                                    {
                                        tempWeekLT = {'$lte': newEndDate.toISOString()};  
                                    }
                                    var tempquery = $.extend({}, tempWeekGT, tempWeekLT);
                                    weekQuery[timeColumn] = tempquery;
                                }

                                collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":sliceText, "complete":false, "tempresult":0, "result":0});
                                collectionRange = [];
                                //Increment one month
                                newStartDate.setMonth(newStartDate.getMonth() + 1);                  
                            } else if(timeslice == 'Weekly')
                            {
                                var prevStartDate = new Date(newStartDate.getTime());
                                var checkDate = new Date(newStartDate.getTime());
                                var countShift = 0;
                                //Cycle for 7 days, or until the end, or until the month changes
                                while(dates.compare(checkDate,newEndDate) <= 0 && countShift < 8 && checkDate.getMonth() == newStartDate.getMonth())
                                {
                                    countShift++;
                                    checkDate.setDate(checkDate.getDate() + 1);
                                }
                                if(countShift == 8)
                                {
                                    //Successfully counted 7 days to shift will not change month or go past end of compare time
                                    newStartDate.setDate(newStartDate.getDate() + 7);
                                } else {
                                    //back up one day from countShift because that day failed a test
                                    newStartDate.setDate(newStartDate.getDate() + countShift-1);                                    
                                }
                                                 
                                var nextStartDate = new Date(newStartDate.getTime());
                                //Push to end of day
                                nextStartDate.setHours(23);
                                nextStartDate.setMinutes(59);
                                nextStartDate.setSeconds(59);
                                nextStartDate.setMilliseconds(999);       
                                        
                                var sliceText = prevStartDate.toLocaleDateString() + " to " + newStartDate.toLocaleDateString();
                                var weekQuery = {};
                                weekQuery[timeColumn] = {'$gte': prevStartDate.toISOString(), '$lte': nextStartDate.toISOString()};  
                                collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":sliceText, "complete":false, "tempresult":0, "result":0});
                                collectionRange = [];
                                
                                //Add one more day
                                newStartDate.setDate(newStartDate.getDate() + 1);   
                            } else if(timeslice == 'Daily')
                            {
                            
                                var nextStartDate = new Date(newStartDate.getTime());
                                //Push to end of day
                                nextStartDate.setHours(23);
                                nextStartDate.setMinutes(59);
                                nextStartDate.setSeconds(59);
                                nextStartDate.setMilliseconds(999);
                                
                                var sliceText = newStartDate.toLocaleDateString();
                                var weekQuery = {};
                                weekQuery[timeColumn] = {'$gte': newStartDate.toISOString(), '$lte': nextStartDate.toISOString()};
                                collectionRanges.push({"range":collectionRange, "timequery":weekQuery, "slice":sliceText, "complete":false, "tempresult":0, "result":0});
                                collectionRange = [];
                                
                                //Add one more day
                                newStartDate.setDate(newStartDate.getDate() + 1);  
                            }
                        }
                        
                        console.log(collectionRanges);
                        if(collectionRanges.length == 0)
                        {
                            return false;
                        } else {
                            return true;
                        }
                        
                    };
                    
                    function updateRequest()
                    {
                        //merge query and timequery if exists
                        var tempquery = $.extend({}, query, collectionRanges[collectionGroup]['timequery']);
                        console.log(tempquery);
                        request = {"query":tempquery,"collection":collectionRanges[collectionGroup]['range'][collectionInc],"increment":increment,"step":step};
                    };
                    
                    //Handle breaking down the query into different collections
                    function nextQuery() {
                        if(collectionRanges.length > collectionGroup)
                        {
                            collectionInc++;
                            if(collectionRanges[collectionGroup]['range'].length > collectionInc)
                            {
                                step = -1;//reset Step - will be incremented later
                                
                                updateRequest();

                                ajaxProcess();
                            } else {
                                //Complete
                                updateCount(collectionGroup,true);
                                
                                collectionGroup++;
                                
                                //Check if more groups
                                if(collectionGroup < collectionRanges.length)
                                {
                                    //Reset group counters
                                    step = -1;//reset Step - will be incremented later
                                    collectionInc = 0;
                                    currentCount = 0;
                                    
                                    updateRequest();
                                    
                                    ajaxProcess();
                                } else {
                                    //fully complete
                                    completeUpdate();
                                }
                            }
                        }
                        
                    };
                    
                    //Callback from success of AJAX call
                    function process(response) {
                        //{"success":'true', "totalcount" : totalcount, "input": input};
                        if(response['success'] == 'true')
                        {
                            currentCount = currentCount + response['totalcount'];
                            updateCount(collectionGroup,false);
                        }
                        if(response['totalcount'] == increment)
                        {
                            //Call again
                            ajaxProcess();
                        } else {
                            nextQuery();
                        }
                        //console.log(response['input1']);
                        //console.log(response['input2']);
                        //console.log(response['input3']);
                    };
                    
                    //Cycle through steps until result total is 0
                    function ajaxProcess() {
                        request['step'] = request['step'] + 1;
                        //console.log(request['query']);
                        ajaxQuery = $.ajax({
                            url: scriptLocation,
                            type: "post",
                            data: JSON.stringify(request),
                            dataType: "json",
                            contentType: 'application/json; charset=utf-8',
                            success: process
                        });
                    };
                    alreadySetup = true;
                }

                var alreadySetup = false;
                
                
                $('.label-to-csv').hide();

            });//end READY FUNCTION
            window.no_ajax = true;
            </script>
            <style>
            .hidden {
              display:none;
            }
            </style>
            <script src='plugins/datatables/jquery.dataTables.js'></script>
            <script src='plugins/datatables/ZeroClipboard.js'></script>
            <script src='plugins/datatables/TableTools.js'></script>
            <script src='plugins/datatables/dataTables.colReorder.min.js'></script>
            <script src='plugins/datatables/dataTables.bootstrap.js'></script>
            <script src='plugins/select2/select2.min.js'></script>
            <script src='plugins/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.min.js'></script>
